<!DOCTYPE html>
<html>
<head>
<title>安全红线后台代码修改汇总</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
</head>
<body>
<p>globalMessages_zh_CN.properties</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/resources/language/globalMessages_zh_CN.properties

login.usernameorpassworderror=用户名或密码错误
login.userroleerror=用户未绑定角色
login.validate.code=验证码输入错误
login.pwd.default=密码为初始密码，请修改密码
login.login.first=首次登录平台，请修改密码
</code></pre>

<p>pom.xml</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/pom.xml

&lt;!-- fastjson --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
    &lt;artifactId&gt;fastjson&lt;/artifactId&gt;
    &lt;version&gt;1.2.28&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- kaptcha --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.google.code.kaptcha&lt;/groupId&gt;
    &lt;artifactId&gt;kaptcha&lt;/artifactId&gt;
    &lt;version&gt;2.3.2&lt;/version&gt;
    &lt;classifier&gt;jdk16&lt;/classifier&gt;
&lt;/dependency&gt;

&lt;!-- Struts2 jar 升级 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;commons-fileupload&lt;/groupId&gt;
    &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt;
    &lt;version&gt;1.3.1&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.freemarker&lt;/groupId&gt;
    &lt;artifactId&gt;freemarker&lt;/artifactId&gt;
    &lt;version&gt;2.3.22&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;ognl&lt;/groupId&gt;
    &lt;artifactId&gt;ognl&lt;/artifactId&gt;
    &lt;version&gt;3.1.12&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.apache.struts&lt;/groupId&gt;
    &lt;artifactId&gt;struts2-core&lt;/artifactId&gt;
    &lt;version&gt;2.3.32&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.apache.struts&lt;/groupId&gt;
    &lt;artifactId&gt;struts2-json-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.3.31&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.apache.struts&lt;/groupId&gt;
    &lt;artifactId&gt;struts2-spring-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.3.32&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.apache.struts.xwork&lt;/groupId&gt;
    &lt;artifactId&gt;xwork-core&lt;/artifactId&gt;
    &lt;version&gt;2.3.32&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- 漏洞扫描 jar包升级 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;commons-collections&lt;/groupId&gt;
    &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;
    &lt;version&gt;3.2.2&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- 漏洞扫描 jar包升级  END--&gt;
</code></pre>

<p>swdf-task.xml：新增两个定时任务</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/resources/spring/swdf-task.xml

&lt;!-- userlogincheck定期清除任务  周期：天 --&gt;
&lt;bean id=&quot;userCheckTask&quot; class=&quot;com.hikvision.finance.cvtms.system.task.UserCheckTask&quot; autowire=&quot;byName&quot;&gt;
    &lt;property name=&quot;schedulingPattern&quot; value=&quot;* 0 1 * * *&quot;&gt;&lt;/property&gt;
&lt;/bean&gt;

&lt;!-- 每30分钟执行一次 --&gt;
&lt;bean id=&quot;memoryTimeTask&quot; class=&quot;com.hikvision.finance.cvtms.common.task.MemoryTimeTask&quot; autowire=&quot;byName&quot;&gt;
    &lt;property name=&quot;schedulingPattern&quot; value=&quot;0 */30 * * * *&quot; /&gt;
&lt;/bean&gt;
</code></pre>

<p>spring-hibernate.xml</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/resources/spring/spring-hibernate.xml

&lt;!-- 配置事务的传播特性 --&gt;
&lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;hibernateTxManager&quot;&gt;
    &lt;tx:attributes&gt;
        //... 保持不变 新增validateLoginUser
        &lt;tx:method name=&quot;validateLoginUser&quot; propagation=&quot;REQUIRED&quot; rollback-for=&quot;Exception&quot;/&gt;
        &lt;tx:method name=&quot;*&quot; read-only=&quot;true&quot; /&gt;
    &lt;/tx:attributes&gt;
&lt;/tx:advice&gt;
</code></pre>

<p>spring-config-bean.xml：增加三个bean的配置</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/resources/spring/spring-config-bean.xml

&lt;bean id=&quot;userLoginCheckDao&quot; class=&quot;com.hikvision.finance.cvtms.modules.users.dao.impl.UserLoginCheckDaoImpl&quot; autowire=&quot;byName&quot;&gt;&lt;/bean&gt;
&lt;bean id=&quot;userIdAndSessionDao&quot; class=&quot;com.hikvision.finance.cvtms.modules.users.dao.impl.UserIdAndSessionDaoImpl&quot; autowire=&quot;byName&quot;&gt;&lt;/bean&gt;
&lt;bean id=&quot;userIdAndSessionService&quot; class=&quot;com.hikvision.finance.cvtms.modules.users.service.impl.UserIdAndSessionServiceImpl&quot; autowire=&quot;byName&quot;&gt;&lt;/bean&gt;
</code></pre>

<p>添加工具类</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/common/util

ValidateUtil.java
Base64.java
PasswordEncryptUtil.java
XSSTranslator.java
</code></pre>

<p>修改Constants.SysConfigType</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/common/util/Constants.java

//ADD 2017-02-22
public static final int USER_AND_IP_LOCK                    = 7001;//用户和IP锁定功能
public static final int FAIL_TIMES                          = 7002;//连续失败次数
public static final int LOCK_MINUTES                        = 7003;//用户和IP锁定时长
</code></pre>

<p>增加类</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/users/qo/UserLoginCheckQo.java

https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/users/dao/impl/UserLoginCheckDaoImpl.java

https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/users/dao/IUserLoginCheckDao.java

https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/model/rbac/UserLoginCheck.java

https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/model/rbac/UserIdAndSession.java

https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/system/task/UserCheckTask.java

https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/common/task/MemoryTimeTask.java

https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/users/dao/impl/UserIdAndSessionDaoImpl.java

https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/users/dao/IUserIdAndSessionDao.java

https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/users/qo/UserIdAndSessionQo.java 

https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/users/service/IUserIdAndSessionService.java

https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/users/service/impl/UserIdAndSessionServiceImpl.java
</code></pre>

<p>LoginAction</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/system/action/LoginAction.java

public class LoginAction extends BaseAction&lt;Users&gt; {
    //... 不变
    private String passwordSecurityLevel;

    private String randomCode;
    private String ip;
    private IUserIdAndSessionService userIdAndSessionService;

    /**
     * Web登录方法
     * @author chenliujie 2015年7月14日 下午10:40:00
     * @return
     */
    public String login() {
        String method = ServletActionContext.getRequest().getMethod();
        if (!&quot;POST&quot;.equals(method)) {// AppScan扫描出“查询中接受的主体参数”缺陷，需要禁用GET方法
            throw new ExpectedException(&quot;&quot;, &quot;请求方法错误&quot;);
        }

        username = entity.getStrName();
        String result = userLoginCheck(ip);
        if(null != result ){
            return result;
        }

        ajaxData = loginService.validateLoginUser(entity, ip);
        if(ajaxData.getSuccess()) { // 登录成功，设置session
            //... 不变
        }
        ajaxData.getData().remove(&quot;user&quot;);
        ajaxData.getData().remove(&quot;role&quot;);
        ajaxData.getData().remove(&quot;menus&quot;);
        ajaxData.getData().remove(&quot;menuscs&quot;);
        return AJAX;
    }

    private String userLoginCheck(String ip){
        if(!&quot;yzm&quot;.equals(randomCode) ){//只进行验证码验证
            if (ValidateUtil.isValidateCode(getRequest(), randomCode)) {
                ajaxData.setAutoSet(false);
                ajaxData.setFailureMsg(GlobalMessageUtil.getMessage(&quot;login.validate.code&quot;));
                return AJAX;
            }
        }
        UserLoginCheck userLoginCheck = loginService.getUserLoginCheck(username, ip);
        if(userLoginCheck != null){
            Integer times = userLoginCheck.getTimes();//失败次数
            Date updateTime = userLoginCheck.getUpdateTime();//最后登录失败的时间

            SysconfigDto sysconfigDto = sysconfigService.getSysconfig();
            Integer maxFailNum = sysconfigDto.getMaxFailNum();//最大连续失败次数
            Integer lockMinutes = sysconfigDto.getLockMinutes();//锁定时间
            long minusTime = System.currentTimeMillis() - updateTime.getTime();//毫秒数  当前时间和最后失败时间的时间差
            if(&quot;1&quot;.equals(String.valueOf(sysconfigDto.getEnableLock())) &amp;&amp; times &gt;= maxFailNum){//判断用户或IP是否锁定，是否开启锁定功能
                if(minusTime &lt; 1000L*60*lockMinutes){
                    long leftTime = 1000L*60*lockMinutes - minusTime;//还有多久解锁

                    long seconds = leftTime / 1000 ;
                    if(leftTime % 1000 != 0){
                        seconds += 1;
                    }
                    long leftMinutes = seconds / 60;
                    long leftSeconds = seconds % 60;
                    ajaxData.setAutoSet(false);
                    if(leftMinutes == 0 &amp;&amp; leftSeconds != 0){
                        ajaxData.setFailureMsg(&quot;账户已被锁定，请&quot;+leftSeconds+&quot;秒后再试&quot;);
                    }else if(leftMinutes != 0 &amp;&amp; leftSeconds == 0){
                        ajaxData.setFailureMsg(&quot;账户已被锁定，请&quot;+leftMinutes+&quot;分钟后再试&quot;);
                    }else if(leftMinutes != 0 &amp;&amp; leftSeconds != 0){
                        ajaxData.setFailureMsg(&quot;账户已被锁定，请&quot;+leftMinutes+&quot;分钟&quot;+leftSeconds+&quot;秒后再试&quot;);
                    }
                    return AJAX;
                }else{
                    loginService.unlockUser(username, ip);
                }

            }
        }
        return null;
    }

    /**
     * 修改密码
     * @author fuqunqing 2015年8月17日 下午7:52:16
     * @return
     */
    public String changePassword() {
        //... 不变
        if(ajaxData.getSuccess()) {
            OperationLogUtils.setContent(GlobalMessageUtil.getMessage(&quot;log.others.password.change&quot;));
            sessionProcessor.removeSession(getResponse(), getRequest());
        }
        return AJAX;
    }

    /**
     * 构建session信息
     * @author fuqunqing 2015年8月28日 上午10:55:23
     * @param ajaxData
     * @return
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private HikWebSession buildSession(AjaxData ajaxData) {
        HikWebSession hikSession = new HikWebSession();
        Users user = (Users)ajaxData.get(&quot;user&quot;);
        UserSession userSession = (UserSession)ajaxData.get(SessionAttrbutes.USER_SESSION);
        List&lt;MenuBean&gt; menus = (List&lt;MenuBean&gt;)ajaxData.get(&quot;menus&quot;);
        List&lt;MenuBean&gt; menuscs = (List&lt;MenuBean&gt;)ajaxData.get(&quot;menuscs&quot;);

        String sessionId = UUIDUtils.getUUID();
        hikSession.setAttribute(HikWebSession.KEY_SESSION_ID, sessionId);
        hikSession.setAttribute(HikWebSession.KEY_SESSION_USER, user.getId().toString());
        hikSession.setAttribute(HikWebSession.KEY_SESSION_NAME, user.getStrName());
        hikSession.setAttribute(SessionAttrbutes.MENUS, menus);
        hikSession.setAttribute(SessionAttrbutes.MENUS_CS, menuscs);
        hikSession.setAttribute(SessionAttrbutes.USER_SESSION, userSession);

        UserIdAndSessionQo userIdAndSessionQo = new UserIdAndSessionQo();
        userIdAndSessionQo.setUserId(user.getId());
        userIdAndSessionQo.setClientType(1);
        UserIdAndSession userIdAndSession = userIdAndSessionService.queryUnique(userIdAndSessionQo);
        if(null == userIdAndSession){
            userIdAndSession = new UserIdAndSession();
            userIdAndSession.setUserId(user.getId());
            userIdAndSession.setClientType(1);
            userIdAndSession.setSessionId(sessionId);
            userIdAndSessionService.save(userIdAndSession);
        }else{
            userIdAndSession.setSessionId(sessionId);
            userIdAndSessionService.update(userIdAndSession);
        }

        // 该IP是通过前端页面获取的UMCC服务器访问IP地址，用于定位网域
        String ip = StringUtils.defaultIfBlank(getRequest().getParameter(&quot;ip&quot;), &quot;&quot;).trim();
        if(StringUtils.indexOf(ip, &quot;:&quot;) &gt; -1) {
            ip = ip.substring(0, ip.indexOf(&quot;:&quot;));
        }
        hikSession.setAttribute(HikWebSession.KEY_SESSION_IP, ip);
        return hikSession;
    }
}

private boolean setSession(HikWebSession hikSession) {
    String expire = ConfigManager.getConfiguration(&quot;web-session&quot;, &quot;session.expire&quot;);
    if(StringUtils.isEmpty(expire)) {
        expire = &quot;20&quot;;
    }
    //CookieUtil.setCookie(getResponse(), &quot;HIK_COOKIE_STYLE&quot;, StringUtils.defaultIfBlank(&quot;&quot;, &quot;default&quot;), 30 * 24 * 60 * 60, &quot;/&quot;, null);
    boolean result = sessionProcessor.setSession(getRequest(), getResponse(), hikSession, Integer.parseInt(expire.trim()) * 60 * 1000);
    return result;
}
</code></pre>

<p>ILoginService接口增加方法和修改方法</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/system/service/ILoginService.java

public interface ILoginService {

    /**
     * 通过用户名和IP去获取该用户的登录校验信息
     * @author wangxinglei 2017年2月22日 下午2:08:58
     * @param username
     * @return
     */
    UserLoginCheck getUserLoginCheck(String username, String ip);

    /**
     * 解锁用户
     * @author wangxinglei 2017年3月16日 上午11:20:16
     * @param username
     * @param ip
     */
    void unlockUser(String username, String ip);

    /**
     * 验证登录用户
     * @author chenliujie 2015年7月15日 下午6:29:31
     * @param entity
     * @return
     */
    AjaxData validateLoginUser(Users entity, String ip);

}
</code></pre>

<p>LoginServiceImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/system/service/impl/LoginServiceImpl.java

private IUserLoginCheckDao userLoginCheckDao;

public UserLoginCheck getUserLoginCheck(String username, String ip) {
    UserLoginCheckQo qo = new UserLoginCheckQo();
    qo.setUsername(username);
    qo.setUserIp(ip);
    UserLoginCheck userLoginCheck = userLoginCheckDao.queryUnique(qo);
    return userLoginCheck;
}
public void unlockUser(String username, String ip) {
    userLoginCheckDao.unlockUser(username, ip);
}

private String getWarning(Integer maxFail, Integer curFail){
    if(maxFail &lt;= curFail){
        return &quot;该账户已被锁定&quot;;
    }else{
        return &quot;还有&quot;+(maxFail-curFail)+&quot;次机会&quot;;
    }
}
private void resetUserLoginCheck(String username, String ip){
    UserLoginCheck userLoginCheck = getUserLoginCheck(username, ip);
    if(userLoginCheck != null){
        userLoginCheck.setTimes(0);
        userLoginCheck.setUpdateTime(new Date());
        userLoginCheckDao.saveOrUpdate(userLoginCheck);
    }
}
private Integer saveUserCheckInfo(Users user, String ip){
    UserLoginCheck userLoginCheck = getUserLoginCheck(user.getStrName(), ip);
    if(userLoginCheck == null){
        userLoginCheck = new UserLoginCheck();
        userLoginCheck.setUsername(user.getStrName());
        userLoginCheck.setUserIp(ip);
        userLoginCheck.setTimes(1);
    }else{
        userLoginCheck.setTimes(userLoginCheck.getTimes()+1);
    }
    userLoginCheck.setUpdateTime(new Date());
    userLoginCheckDao.saveOrUpdate(userLoginCheck);
    return userLoginCheck.getTimes();
}

public AjaxData validateLoginUser(Users entity, String ip) {
    AjaxData ajaxData = new AjaxData(false);

    SysconfigDto sysconfigDto = sysconfigService.getSysconfig();
    Integer maxFail = sysconfigDto.getMaxFailNum();
    // 1，授权检查
    String authorizeInfo = this.getAuthorizeInfo();
    if (authorizeInfo != null) {
        Integer curFail = saveUserCheckInfo(entity, ip);
        //return ajaxData.setFailureMsg(authorizeInfo+&quot;,&quot;+getWarning(maxFail, curFail));
        return ajaxData.setFailureMsg(authorizeInfo);
    }

    // 2，检查用户
    List&lt;Users&gt; list = usersDao.findBy(new String[] {&quot;strName&quot;}, new Object[] {entity.getStrName()});
    // 2.1，用户名不存在
    if(list == null || list.size() == 0) {
        return ajaxData.setFailureMsg(GlobalMessageUtil.getMessage(&quot;login.usernameerror&quot;));
    } else {
        Users user = list.get(0);
        ajaxData.put(&quot;user&quot;, user);
        // 2.2，密码不匹配
        if(!user.getStrPassword().equals(entity.getStrPassword())) {
            Integer curFail = saveUserCheckInfo(user, ip);
            return ajaxData.setFailureMsg(GlobalMessageUtil.getMessage(&quot;login.pwderror&quot;)+&quot;,&quot;+getWarning(maxFail, curFail));
        } else {
            if(!user.getStrName().equals(&quot;admin&quot;)) {
                // 2.3，用户已经过期
                if(user.getDtExpirationTime().before(new Date())) {
                    Integer curFail = saveUserCheckInfo(user, ip);
                    return ajaxData.setFailureMsg(GlobalMessageUtil.getMessage(&quot;login.expire&quot;)+&quot;,&quot;+getWarning(maxFail, curFail));
                }
                // 2.4，用户已经禁用
                if(user.getNstate() == 0) {
                    Integer curFail = saveUserCheckInfo(user, ip);
                    return ajaxData.setFailureMsg(GlobalMessageUtil.getMessage(&quot;login.disable&quot;)+&quot;,&quot;+getWarning(maxFail, curFail));
                }
            }

            // 2.5，验证密码保险期
            Integer passwordFresh = Integer.parseInt(sysconfigDto.getPasswordFresh());
            if(passwordFresh != null &amp;&amp; passwordFresh != 0) {
                Calendar calendar = Calendar.getInstance();
                calendar.add(Calendar.MONTH, -passwordFresh);
                Date date = calendar.getTime();
                if(user.getDtUpdatePwdTime().before(date)) {
                    ajaxData.put(&quot;type&quot;, FailureType.PASSWORD_UNFRESH);
                    Integer curFail = saveUserCheckInfo(user, ip);
                    return ajaxData.setFailureMsg(GlobalMessageUtil.getMessage(&quot;login.pwd.unfresh&quot;)+&quot;,&quot;+getWarning(maxFail, curFail));
                }
            }

            //2.3，判断首次登录，记录是否首次登录
            if(user.getDtLastOnlineTime()==null){
                user.setDtLastOnlineTime(new Date());//设置最后的登录时间
                usersDao.update(user);

                resetUserLoginCheck(user.getStrName(), ip);

                ajaxData.setAutoSet(false);
                ajaxData.put(&quot;type&quot;, FailureType.PASSWORD_DEFAULT);
                ajaxData.setFailureMsg(GlobalMessageUtil.getMessage(&quot;login.login.first&quot;));
                return ajaxData;
            }

            //2.2，判断密码是否为初始密码
            String passwordDefault = sysconfigDto.getPasswordDefault();
            if (user.getStrPassword().equals(passwordDefault)) {
                resetUserLoginCheck(user.getStrName(), ip);

                ajaxData.setAutoSet(false);
                ajaxData.put(&quot;type&quot;, FailureType.PASSWORD_DEFAULT);
                ajaxData.setFailureMsg(GlobalMessageUtil.getMessage(&quot;login.pwd.default&quot;));
                return ajaxData;
            }

            // 2.6，没有绑定角色
            List&lt;Role&gt; roles = roleDao.getRoleByUserId(user.getId());
            if(roles == null || roles.size() == 0) { 
                Integer curFail = saveUserCheckInfo(user, ip);
                return ajaxData.setFailureMsg(GlobalMessageUtil.getMessage(&quot;login.userroleerror&quot;,new String[] {entity.getStrName()})+&quot;,&quot;+getWarning(maxFail, curFail));
            } else {
                // 当前系统只支持单角色绑定
                Role role = roles.get(0);
                ajaxData.put(&quot;role&quot;, role);
                // 获取角色菜单权限
                List&lt;Power&gt; powers = null;
                if (role.getNtype() == RoleType.SYSTEM_MANAGER) {
                    powers = powerDao.getAll();
                } else {
                    powers = powerDao.getPowersByRoleId(role.getId());
                }
                List&lt;MenuBean&gt; menus = buildMenus(powers, &quot;0&quot;, Constants.SYSYEMBS); // strSuper为0是一级菜单
                List&lt;MenuBean&gt; menuscs = buildMenus(powers, &quot;0&quot;, Constants.SYSYEMCS); // strSuper为0是一级菜单
                UserSession userSession = buildUserSession(user, role, powers);

                user.setDtLastOnlineTime(new Date());//设置最后的登录时间

                ajaxData.put(&quot;menus&quot;, menus);
                ajaxData.put(&quot;menuscs&quot;, menuscs);
                ajaxData.put(SessionAttrbutes.USER_SESSION, userSession);

                resetUserLoginCheck(user.getStrName(), ip);
            }
        }
    }
    return ajaxData;
}
</code></pre>

<p>实体类字段添加</p>
<p>Users</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/model/rbac/Users.java

//2017-02-23 ADD
private Date dtLastOnlineTime;//最后登录系统的时间   
</code></pre>

<p>Workstate</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/model/sys/Workstate.java

private Integer resetFlag;//0 未重置密码 1 重置密码
</code></pre>

<p>Device</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/model/device/Device.java

//2017-02-23 ADD
private Integer passwordLevel;//密码等级
</code></pre>

<p>Vehicle</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/model/device/Vehicle.java

//2017-02-23 ADD
private Integer passwordLevel;//密码等级
</code></pre>

<p>CMSException</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/common/exception/CMSException.java   

/**
 * 用户密码重置
 */
public static final int PASSWORD_RESET_ERROR = 10100003;
</code></pre>

<p>IWorkStateDao 增加</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/cms/dao/IWorkStateDao.java

/**
 * 修改重置密码标志
 * @author wangxinglei 2017年3月2日 下午2:04:17
 * @param ids
 */
public void updateByIds(List&lt;Integer&gt; ids);
</code></pre>

<p>WorkStateQo</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/cms/qo/WorkStateQo.java

private List&lt;Integer&gt; nuserOrSerIds;
</code></pre>

<p>WorkStateDaoImpl 增加和修改</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/cms/dao/impl/WorkStateDaoImpl.java

protected Criteria buildCriteria(Criteria criteria, WorkStateQo qo) {
    if (qo != null) {
        //...保持不变

        //增加
        if (qo.getNuserOrSerIds() != null) {
            criteria.add(Restrictions.in(&quot;nuserOrSerId&quot;, qo.getNuserOrSerIds()));
        }
    }
    return criteria;
}

@Override
public void updateByIds(List&lt;Integer&gt; ids) {
    String hql = &quot;update Workstate a set a.resetFlag = 1 where a.nuserOrSerId in (:ids)&quot;;
    Query q = this.createQuery(hql);
    q.setParameterList(&quot;ids&quot;, ids);
    q.executeUpdate();
}
</code></pre>

<p>HReqClientLoginServiceImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/cms/hppservice/client/HReqClientLoginServiceImpl.java

private IUserLoginCheckDao userLoginCheckDao;
private ISysconfigService sysconfigService;
private IUserIdAndSessionService userIdAndSessionService;
/**
 * 用户密码输入正确后，重置用户校验信息
 * @author wangxinglei 2017年3月20日 下午3:09:32
 */
private void resetUserLoginCheck(String username, String ip){
    UserLoginCheck userLoginCheck = getUserLoginCheck(username, ip);
    if(userLoginCheck != null){
        userLoginCheck.setTimes(0);
        userLoginCheck.setUpdateTime(new Date());
        userLoginCheckDao.saveOrUpdate(userLoginCheck);
    }
}

/**
 * 提示信息
 * @author wangxinglei 2017年3月20日 下午7:46:39
 * @param maxFail
 * @param curFail
 * @return
 */
private String getWarning(Integer maxFail, Integer curFail){
    if(maxFail &lt;= curFail){
        return &quot;该账户已被锁定&quot;;
    }else{
        return &quot;还有&quot;+(maxFail-curFail)+&quot;次机会&quot;;
    }
}

/**
 * 用户登录检查项数据更新
 * @author wangxinglei 2017年2月22日 下午4:55:58
 * @param user
 * @param ip
 */
private Integer saveUserCheckInfo(String username, String ip){
    UserLoginCheck userLoginCheck = getUserLoginCheck(username, ip);
    if(userLoginCheck == null){
        userLoginCheck = new UserLoginCheck();
        userLoginCheck.setUsername(username);
        userLoginCheck.setUserIp(ip);
        userLoginCheck.setTimes(1);
    }else{
        userLoginCheck.setTimes(userLoginCheck.getTimes()+1);
    }
    userLoginCheck.setUpdateTime(new Date());
    userLoginCheckDao.saveOrUpdate(userLoginCheck);
    return userLoginCheck.getTimes();
}

/**
 * 通过用户名和IP获取UserLoginCheck信息
 * @author wangxinglei 2017年3月20日 下午7:24:09
 * @param username
 * @param ip
 * @return
 */
private UserLoginCheck getUserLoginCheck(String username, String ip){
    UserLoginCheckQo qo = new UserLoginCheckQo();
    qo.setUsername(username);
    qo.setUserIp(ip);
    UserLoginCheck userLoginCheck = userLoginCheckDao.queryUnique(qo);
    return userLoginCheck;
}

/**
 * 验证码和用户IP锁定检查
 * @author wangxinglei 2017年2月22日 下午4:37:49
 * @param ip
 * @return
 */
private String userLoginCheck(String username, String ip){
    UserLoginCheck userLoginCheck = getUserLoginCheck(username, ip);
    if(userLoginCheck != null){
        Integer times = userLoginCheck.getTimes();
        Date updateTime = userLoginCheck.getUpdateTime();

        SysconfigDto sysconfigDto = sysconfigService.getSysconfig();
        Integer maxFailNum = sysconfigDto.getMaxFailNum();
        Integer lockMinutes = sysconfigDto.getLockMinutes();
        long minusTime = System.currentTimeMillis() - updateTime.getTime();
        if(&quot;1&quot;.equals(String.valueOf(sysconfigDto.getEnableLock())) &amp;&amp; times &gt;= maxFailNum ){//判断用户或IP是否锁定，是否开启锁定功能
            if(minusTime &lt; 1000L*60*lockMinutes){
                long leftTime = 1000L*60*lockMinutes - minusTime;
                long seconds = leftTime / 1000 ;
                if(leftTime % 1000 != 0){
                    seconds += 1;
                }
                long leftMinutes = seconds / 60;
                long leftSeconds = seconds % 60;
                if(leftMinutes == 0 &amp;&amp; leftSeconds != 0){
                    return &quot;该账户和IP已被锁定，请&quot;+leftSeconds+&quot;秒后再试&quot;;
                }else if(leftMinutes != 0 &amp;&amp; leftSeconds == 0){
                    return &quot;该账户和IP已被锁定，请&quot;+leftMinutes+&quot;分钟后再试&quot;;
                }else if(leftMinutes != 0 &amp;&amp; leftSeconds != 0){
                    return &quot;该账户和IP已被锁定，请&quot;+leftMinutes+&quot;分钟&quot;+leftSeconds+&quot;秒后再试&quot;;
                }
            }else{
                userLoginCheck.setTimes(0);
                userLoginCheckDao.saveOrUpdate(userLoginCheck);
            }

        }
    }
    return null;
}

/**
 * 处理密码保鲜
 * @author fuqunqing 2015年7月17日 下午2:10:38
 * @param user
 * @param userPwdCheck
 */
private void checkUserPswdExpiration(Users user, String ip, RspClientLoginProto.UserPwdCheck.Builder userPwdCheck, Integer maxFail) {
    Date updatePwdTime = null;
    Date now = new Date();

    Sysconfig config = sysconfigDao.getSysconfigByKey(SysConfigType.KEEP_PASSWORD_FRESH);

    //大于0表示启用密码保鲜
    if (config != null &amp;&amp; StringUtils.isNotEmpty(config.getStrValue()) &amp;&amp; (Integer.parseInt(config.getStrValue()) &gt; 0)) {
        userPwdCheck.setIsPwdcheckEnabled(Constants.ENABLED);
        int nMonth = Integer.valueOf(config.getStrValue());
        updatePwdTime = user.getDtUpdatePwdTime();
        if(updatePwdTime==null)
        updatePwdTime = DateUtils.getDateTime(DateUtils.yyyy_MM_dd_HH_mm_ss, &quot;2000-09-26 00:00:00&quot;);

        Date pwdFreshDate = DateUtils.addMonths(updatePwdTime, nMonth);
        //超出需要修改密码最大时间
        if(now.after(pwdFreshDate)){
            Integer curFail = saveUserCheckInfo(user.getStrName(), ip);
            throw new CMSException(CMSException.USER_PSWD_EXPIRATION, &quot;该用户密码保鲜期已过，&quot;+getWarning(maxFail, curFail));
        }else{
            Long diffDay = (pwdFreshDate.getTime()-now.getTime())/DateUtils.MILLIS_PER_DAY;
            userPwdCheck.setRemainingDays(diffDay.intValue());
        }
    }else{
        userPwdCheck.setIsPwdcheckEnabled(Constants.UNENABLED);
    }
}

public void notifyReqClientLogin(RpcController controller, ReqClientLogin request, RpcCallback&lt;RspClientLogin&gt; done) {

    //... 不变

    try {
        // 2，验证连接状态与授权信息
        verifyBasic();
        verifyAuthorize(rspClientLogin);

        String username = request.getUserName();
        String checkResult = userLoginCheck(username, clientIP);
        if(null != checkResult){
            throw new CMSException(CMSException.LOGIN_USER_UNKONWN_ERROR, checkResult);
        }

        SysconfigDto sysconfigDto = sysconfigService.getSysconfig();
        Integer maxFail = sysconfigDto.getMaxFailNum();

        // 3，验证用户
        UsersQo userqo = new UsersQo();
        userqo.setStrName(username);
        userqo.setStrPassword(request.getUserPwd());
        Users user = usersDao.queryUnique(userqo);
        // 3.1，验证用户名是否存在或密码是否匹配
        if(user == null) {
            Integer curFail = saveUserCheckInfo(username, clientIP);
            throw new CMSException(CMSException.LOGIN_USER_LOGIN_INFO＿ERROR, &quot;用户名不存在或密码错误，&quot;+getWarning(maxFail, curFail));
        }
        if(!user.getStrName().equals(&quot;admin&quot;)) {
            // 3.2，用户已经过期
            if(user.getDtExpirationTime().before(new Date())) {
                Integer curFail = saveUserCheckInfo(username, clientIP);
                throw new CMSException(CMSException.LOGIN_USER_EXPIRE, &quot;该用户已到期，&quot;+getWarning(maxFail, curFail));
            }
            // 3.3，用户已经禁用
            if(user.getNstate() == 0) {
                Integer curFail = saveUserCheckInfo(username, clientIP);
                throw new CMSException(CMSException.LOGIN_USER_DISABLED, &quot;该用户已禁用，&quot;+getWarning(maxFail, curFail));
            }
        }
        // 3.4，验证密码保险期
        checkUserPswdExpiration(user, clientIP, userPwdCheck, maxFail);
        rspClientLogin.setUserPwdCheck(userPwdCheck);

        //2.3，判断首次登录，记录是否首次登录
        if(user.getDtLastOnlineTime()==null){
            resetUserLoginCheck(username, clientIP);
            throw new CMSException(CMSException.LOGIN_USER_UNKONWN_ERROR, &quot;首次登录，请在web端修改用户密码&quot;);
        }

        //2.2，判断密码是否为初始密码
        String passwordDefault = sysconfigDto.getPasswordDefault();
        if (user.getStrPassword().equals(passwordDefault)) {
            resetUserLoginCheck(username, clientIP);
            throw new CMSException(CMSException.LOGIN_USER_UNKONWN_ERROR, &quot;密码为初始密码，请在web端修改用户密码&quot;);
        }

        // 3.5，验证是否绑定角色
        List&lt;Role&gt; roles = roleDao.getRoleByUserId(user.getId());
        if(roles == null || roles.size() == 0) {
            Integer curFail = saveUserCheckInfo(username, clientIP);
            throw new CMSException(CMSException.LOGIN_USER_UNROLE, &quot;该用户未绑定角色，&quot;+getWarning(maxFail, curFail));
        }

        //... 不变
        rspClientLogin.setCopyright(getSysconfigValue(SysConfigType.PLATFORM_COPYRIGHT));// 设置版权描述信息

        resetUserLoginCheck(username, clientIP);

        // 返回数据
        done.run(rspClientLogin.build());
        logger.info(&quot;用户 &quot; + user.getId()+&quot;:&quot;+ user.getStrName() + &quot; 登录成功&quot;);

        //增加在线信息
        CsClientContextUtil.addCsClientSession(user.getId(), HppConstants.TYPE_SERVER + sessionId, clientIP);

    } catch (CMSException e) {
        //... 
    }
    //...
}
</code></pre>

<p>HWorkStateServiceImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/cms/hppservice/log/HWorkStateServiceImpl.java

public void operWWorkState(RpcController controller, WWorkState request, RpcCallback&lt;RspServerData&gt; done) {

    //...
        Workstate workstate = workStateDao.queryUnique(workStateQo);
        if(null != workstate &amp;&amp; null != workstate.getResetFlag() &amp;&amp; 1 == workstate.getResetFlag()){
            workstate.setResetFlag(0);
            workStateDao.update(workstate);

            rsp.setResult(CMSException.PASSWORD_RESET_ERROR);
            rsp.setDataId(HppConstants.RESULT_ERROR);
            rsp.setErrorMsg(PbUtil.parseString(&quot;用户密码已重置，请重新登录&quot;));
            done.run(rsp.build());
            return;
        }

    //...   

}
</code></pre>

<p>CvrDeviceDaoImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/cvrdevice/dao/impl/CvrDeviceDaoImpl.java

public Page queryPageCvrDevice(Integer limit, Integer start, Integer norgId, Integer type,String keyword) {
    SqlQuery sqlQuery = new SqlQuery();
    //增加密码等级
    StringBuffer sql = new StringBuffer(&quot;select ve.id AS id,ve.strUser AS strUser, ve.strIp AS strIp,ve.nport AS nport,ve.strName AS strName, ve.passwordLevel AS passwordLevel FROM vehicle ve &quot;
            + &quot;LEFT JOIN organization org on org.id=ve.norgId &quot;
            + &quot;where ve.ntype=? &quot;);
    //...
}
</code></pre>

<p>CvrDeviceInfo</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/cvrdevice/dto/CvrDeviceInfo.java

private Integer passwordLevel;//密码等级
</code></pre>

<p>CvrDeviceServiceImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/cvrdevice/service/impl/CvrDeviceServiceImpl.java

public ResultData updateCvrDevice(CvrDeviceInfo cvrDeviceInfo) {
    //...

    // 更新CVR信息
    vehicle.setStrName(cvrDeviceInfo.getStrName());
    vehicle.setStrIp(cvrDeviceInfo.getStrIp());
    vehicle.setNport(cvrDeviceInfo.getNport());
    vehicle.setStrUser(cvrDeviceInfo.getStrUser());
    //vehicle.setStrPassword(cvrDeviceInfo.getStrPassword());
    vehicle.setPasswordLevel(cvrDeviceInfo.getPasswordLevel());
    cvrDeviceDao.update(vehicle);

    // 更新设备和服务的关联关系
    //...
}

public ResultData addCvrDevice(CvrDeviceInfo cvrDeviceInfo) {
    //...

    // 保存CVR信息
    //...
    vehicle.setStrUser(cvrDeviceInfo.getStrUser());//用户名
    String pass = SercurityUtil.encrypt(PasswordEncryptUtil.decodeBase64(cvrDeviceInfo.getStrPassword()));
    vehicle.setStrPassword(pass);//密码
    vehicle.setPasswordLevel(cvrDeviceInfo.getPasswordLevel());//设备密码等级
    Integer vehicleId = (Integer) cvrDeviceDao.save(vehicle);

    // 保存设备和服务的关联关系
    //...

}

public ResultData updateCVRPwd(CvrDeviceInfo cvrDeviceInfo) {
    ResultData resultData = new ResultData();
    // 1.验证老密码是否填写正确
    Vehicle cvrDevice = cvrDeviceDao.get(cvrDeviceInfo.getId());
    String passDB = cvrDevice.getStrPassword();// 获取数据库当中的原始密码
    String passFront = SercurityUtil.encrypt(PasswordEncryptUtil.decodeBase64(cvrDeviceInfo.getStrPassword()));// 获取前段传过来的原始密码
    if (!passDB.equals(passFront)) {
        throw new ExpectedException(&quot;&quot;, &quot;原始密码输入有误&quot;);
    }
    // 2.修改新密码
    String passNew = SercurityUtil.encrypt(PasswordEncryptUtil.decodeBase64(cvrDeviceInfo.getNewPassword()));
    cvrDevice.setStrPassword(passNew);
    cvrDevice.setPasswordLevel(cvrDeviceInfo.getPasswordLevel());
    cvrDeviceDao.update(cvrDevice);
    OperationLogUtils.setContent(GlobalMessageUtil.getMessage(&quot;log.cvrDevice.updatePwd&quot;, new String[] {cvrDevice.getStrName()}));
    resultData.setId(cvrDeviceInfo.getId());
    resultData.setSuccess(true);
    return resultData;
}

public ResultData updateCVRPwdReset(CvrDeviceInfo cvrDeviceInfo) {
    ResultData resultData = new ResultData();
    //1.验证登陆密码是否填写正确
    Integer userId = SessionUtil.getUserSession().getUserId();// 通过session的uerid获取数据库当中的原始密码
    String passUser = usersDao.get(userId).getStrPassword();
    String passFrontLogin = cvrDeviceInfo.getLoginPassword();// 获取前段传过来的登陆密码,加密后和数据库登陆密码对比
    if (!passUser.equals(passFrontLogin)) {
        throw new ExpectedException(&quot;&quot;, &quot;登陆密码输入有误&quot;);
    }
    //2.修改新密码
    Vehicle cvrDevice = cvrDeviceDao.get(cvrDeviceInfo.getId());
    String passNew = SercurityUtil.encrypt(PasswordEncryptUtil.decodeBase64(cvrDeviceInfo.getNewPassword()));
    cvrDevice.setStrPassword(passNew);
    cvrDevice.setPasswordLevel(cvrDeviceInfo.getPasswordLevel());
    cvrDeviceDao.update(cvrDevice);
    OperationLogUtils.setContent(GlobalMessageUtil.getMessage(&quot;log.cvrDevice.updatePwd&quot;, new String[] {cvrDevice.getStrName()}));
    resultData.setId(cvrDeviceInfo.getId());
    resultData.setSuccess(true);
    return resultData;
}
</code></pre>

<p>EscortplanDaoImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/escort/dao/impl/EscortplanDaoImpl.java

public void deleteByIds(Serializable[] paramArrayOfSerializable) {
    StringBuffer hql = new StringBuffer(&quot;DELETE FROM &quot;);
    hql.append(getEntityClass().getName());
    hql.append(&quot; WHERE id in (:ids)&quot;);
    Query query = createQuery(hql.toString());
    query.setParameter(&quot;ids&quot;, StringUtils.join(paramArrayOfSerializable));
    query.executeUpdate();
}

public List&lt;Escortplan&gt; queryEscortplanListBySQL(Date start, Date end) {
    String sql1 = &quot;from Escortplan where dtStart &lt;= ? and dtEnd &gt; ? &quot;;
    String sql2 = &quot;from Escortplan where dtStart &gt; ? and dtStart &lt; ? &quot;;

    List&lt;Escortplan&gt; list1 = this.createQuery(sql1).setParameter(0, start).setParameter(1,  end).list();
    List&lt;Escortplan&gt; list2 = this.createQuery(sql2).setParameter(0, start).setParameter(1,  end).list();

    list1.addAll(list2);
    return list1;
}
public List&lt;VehicleTodayEscortStatus&gt; isTodayEscortplan(List&lt;Integer&gt; vehicleIds) {
    String sql = &quot;select distinct nvehicleId from escortplan where dutyDate = ?&quot;;
    List&lt;Integer&gt; todayIds = this.createSQLQuery(sql).setParameter(0, DateUtils.getStringDateTime(DateFormatUtils.getZeroTime().getTime())).list();
    List&lt;VehicleTodayEscortStatus&gt; vtess = new ArrayList&lt;VehicleTodayEscortStatus&gt;();
    //...
}
</code></pre>

<p>EscortplanstaffDaoImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/escort/dao/impl/EscortplanstaffDaoImpl.java

public void deleteByIds(Serializable[] paramArrayOfSerializable) {
    StringBuffer hql = new StringBuffer(&quot;DELETE FROM &quot;);
    hql.append(getEntityClass().getName());
    hql.append(&quot; WHERE id in (:ids)&quot;);
    Query query = createQuery(hql.toString());
    query.setParameter(&quot;ids&quot;, StringUtils.join(paramArrayOfSerializable));
    query.executeUpdate();
}
</code></pre>

<p>EscortplanServiceImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/escort/service/impl/EscortplanServiceImpl.java

public Integer add(Escortplan escortplan, List&lt;Escortplanstaff&gt; escortplanstaffs) {
    if(XSSTranslator.clsInterceptor(escortplanstaffs)){
        throw new ExpectedException(&quot;&quot;, &quot;参数信息错误&quot;);
    }
    // 1.1 验证押运计划是否重复
    if(!escortplanDao.validateSamePlans(escortplan)){
        throw new ExpectedException(&quot;&quot;, GlobalMessageUtil.getMessage(&quot;escortplan.exist&quot;));
    }
    //...
}

public void update(Escortplan escortplan, List&lt;Escortplanstaff&gt; escortplanstaffs) {
    if(XSSTranslator.clsInterceptor(escortplanstaffs)){
        throw new ExpectedException(&quot;&quot;, &quot;参数信息错误&quot;);
    }
    // 1.1验证押运计划是否重复
    if(!escortplanDao.validateSamePlans(escortplan)){
        throw new ExpectedException(&quot;&quot;, GlobalMessageUtil.getMessage(&quot;escortplan.exist&quot;));
    }
    //...
}
</code></pre>

<p>AlarmeventlogDaoImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/eventInfo/dao/impl/AlarmeventlogDaoImpl.java

public int delExpireLog(int num) {
    String sql = &quot;delete from alarmeventlog where To_Days(NOW()) - To_Days(dtBeginTime) &gt; ?&quot;;
    return this.createSQLQuery(sql).setParameter(0, num).executeUpdate();
}
</code></pre>

<p>OperationlogDaoImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/log/dao/impl/OperationlogDaoImpl.java

public void deleteByIds(Serializable[] paramArrayOfSerializable) {
    StringBuffer hql = new StringBuffer(&quot;DELETE FROM &quot;);
    hql.append(getEntityClass().getName());
    hql.append(&quot; WHERE id in (:ids)&quot;);
    Query query = createQuery(hql.toString());
    query.setParameter(&quot;ids&quot;, StringUtils.join(paramArrayOfSerializable));
    query.executeUpdate();      
}

public int delExpireLog(int num) {
    String sql = &quot;delete from operationlog where To_Days(NOW()) - To_Days(strDate) &gt; ?&quot;;
    return this.createSQLQuery(sql).setParameter(0, num).executeUpdate();
}
</code></pre>

<p>RecordCvrDaoImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/record/dao/impl/RecordCvrDaoImpl.java

public List&lt;Recordcvr&gt; getRecordcvrByCamId(List&lt;Integer&gt; channelIds) {
    if (channelIds != null &amp;&amp; channelIds.size() &gt; 0) {
        String hql = &quot;from Recordcvr where ncamId in (:ids)&quot;;
        return this.getHibernateTemplate().findByNamedParam(hql, &quot;ids&quot;, channelIds.toArray());
    }
    return null;
}

public List&lt;Integer&gt; getCvrPlanByCamId(List&lt;Integer&gt; ids) {
    if(ids!=null &amp;&amp; ids.size()&gt;0) {
        String hql = &quot;select nvrmid from Recordcvr where ncamId in ( :ids ) group by nvrmid&quot;;
        return this.getHibernateTemplate().findByNamedParam(hql, &quot;ids&quot;, ids.toArray());
    }
    return null;
}

public List&lt;Recordcvr&gt; getRecordcvrByVrmIdAndCamId(List&lt;Integer&gt; ids, Integer vrmId) {
    if(ids!=null &amp;&amp; ids.size()&gt;0 &amp;&amp; vrmId!=null) {
        String hql = &quot;from Recordcvr where  ncamId in (:ids) and nvrmid= :nvrmid&quot;;
        return this.getHibernateTemplate().findByNamedParam(hql, new String[]{&quot;ids&quot;,&quot;nvrmid&quot;}, new Object[]{ids.toArray(), vrmId});
    }
    return null;
}
</code></pre>

<p>RoleServiceImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/role/service/impl/RoleServiceImpl.java

private Logger logger = Logger.getLogger(RoleServiceImpl.class);

public AjaxData addRole(String jsonStr) {
    AjaxData ajaxData = new AjaxData(false);
    RoleDto roleDto = JsonUtils.json2Object(jsonStr, RoleDto.class);
    Role role = roleDto.getRole();
    if(XSSTranslator.clsInterceptor(role)){
        logger.error(&quot;非法的参数信息------------------------------&gt;&quot;+jsonStr);
        return ajaxData.setFailureMsg(&quot;非法的参数信息！&quot;);
    }
    //验证角色名称是否存在
    if(roleDao.findUniqueBy(&quot;strName&quot;, role.getStrName()) != null){
        return ajaxData.setFailureMsg(&quot;角色名已存在&quot;);
    }
    //...
}

public AjaxData updateRole(String jsonStr) {
    AjaxData ajaxData = new AjaxData(false);
    RoleDto roleDto = JsonUtils.json2Object(jsonStr, RoleDto.class);
    Role role = roleDto.getRole();
    if(XSSTranslator.clsInterceptor(role)){
        logger.error(&quot;非法的参数信息------------------------------&gt;&quot;+jsonStr);
        return ajaxData.setFailureMsg(&quot;非法的参数信息！&quot;);
    }
    //...
}
</code></pre>

<p>GishistorypointinfoDaoImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/rules/dao/impl/GishistorypointinfoDaoImpl.java

public int delExpireGisPoint(int num) {
    String sql = &quot;delete from gishistorypointinfo where To_Days(NOW()) - To_Days(dtSampleTime) &gt; ?&quot;;
    return this.createSQLQuery(sql).setParameter(0, num).executeUpdate();
}
</code></pre>

<p>RulesServiceImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/rules/service/impl/RulesServiceImpl.java

public AjaxData addPolygon(String jsonStr) {
    AjaxData ajaxData = new AjaxData(false);
    GismappolygonDto polygonDto = JsonUtils.json2Object(jsonStr, GismappolygonDto.class);
    Gismappolygon polygon = polygonDto.getPolygon();
    if(XSSTranslator.clsInterceptor(polygon)){
        logger.error(&quot;请求被拦截，某些参数不符合输入规范------------&gt;&quot;+jsonStr);
        ajaxData.setFailureMsg(&quot;非法的参数信息！&quot;);
        return ajaxData;
    }
    // 1，判断名称是否存在
    //...
}

public AjaxData updatePolygon(String jsonStr) {
    UserSession userSession = SessionUtil.getUserSession();
    AjaxData ajaxData = new AjaxData(false);
    GismappolygonDto polygonDto = JsonUtils.json2Object(jsonStr, GismappolygonDto.class);
    Gismappolygon polygon = polygonDto.getPolygon();
    if(XSSTranslator.clsInterceptor(polygon)){
        logger.error(&quot;请求被拦截，某些参数不符合输入规范------------&gt;&quot;+jsonStr);
        ajaxData.setFailureMsg(&quot;非法的参数信息！&quot;);
        return ajaxData;
    }
    // 1，判断名称是否存在
    //...
}
public AjaxData updatePolygonpoint(String jsonStr) {
    AjaxData ajaxData = new AjaxData(false);
    GismappolygonDto polygonDto = JsonUtils.json2Object(jsonStr, GismappolygonDto.class);
    Gismappolygon polygon = polygonDto.getPolygon();
    if(XSSTranslator.clsInterceptor(polygon)){
        logger.error(&quot;请求被拦截，某些参数不符合输入规范------------&gt;&quot;+jsonStr);
        ajaxData.setFailureMsg(&quot;非法的参数信息！&quot;);
        return ajaxData;
    }
    //...
}
</code></pre>

<p>ServiceUtil</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/server/service/ServiceUtil.java

public static Server getServerParam(Server server) {
    int nctrlPort = 0;
    int ndataPort = 0;
    switch(server.getNtype()) {
        //...
        case Constants.SysDictionary.ServerType.MT_SERVICE_VAG:// VAG服务
            nctrlPort = 7300;
            ndataPort = 7302;
            server.setStrLoginName(VAG_LOGIN.VagLoginName);
            server.setStrPassword(SercurityUtil.encrypt(VAG_LOGIN.VagLoginPwd));
            break;
        //...
    }
    server.setNctrlPort(nctrlPort);
    server.setNdataPort(ndataPort);
    return server;
}
</code></pre>

<p>SysconfigDaoImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/sysconfig/dao/impl/SysconfigDaoImpl.java

public void deleteByIds(Serializable[] paramArrayOfSerializable) {
    StringBuffer hql = new StringBuffer(&quot;DELETE FROM &quot;);
    hql.append(getEntityClass().getName());
    hql.append(&quot; WHERE id in (:ids)&quot;);
    Query query = createQuery(hql.toString());
    query.setParameter(&quot;ids&quot;, StringUtils.join(paramArrayOfSerializable));
    query.executeUpdate();
}
</code></pre>

<p>SysconfigDto</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/sysconfig/dto/SysconfigDto.java

private Integer enableLock;//是否启用锁定功能   1 启用  0 禁用 
private Integer maxFailNum;//登录时最大连续失败次数
private Integer lockMinutes;//锁定时间
</code></pre>

<p>SysconfigServiceImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/sysconfig/service/impl/SysconfigServiceImpl.java

public SysconfigDto getSysconfig() {
    SysconfigDto sysconfigDto = new SysconfigDto();
    List&lt;Integer&gt; nkeys = Lists.newArrayList(
            //...
            SysConfigType.LIMIT_PREVIEW,
            SysConfigType.USER_AND_IP_LOCK,
            SysConfigType.FAIL_TIMES,
            SysConfigType.LOCK_MINUTES);    
    SysconfigQo sysconfigQo = new SysconfigQo();
    sysconfigQo.setNkeys(nkeys);
    List&lt;Sysconfig&gt; configs = sysconfigDao.queryList(sysconfigQo);
    for(Sysconfig config:configs) {
        switch(config.getNkey()) {
            //...
            case SysConfigType.LIMIT_PREVIEW:
                sysconfigDto.setLimitPreview(config.getStrValue());
                break;
            case SysConfigType.USER_AND_IP_LOCK:
                sysconfigDto.setEnableLock(Integer.parseInt(config.getStrValue()));
                break;
            case SysConfigType.FAIL_TIMES:
                sysconfigDto.setMaxFailNum(Integer.parseInt(config.getStrValue()));
                break;
            case SysConfigType.LOCK_MINUTES:
                sysconfigDto.setLockMinutes(Integer.parseInt(config.getStrValue()));
                break;
        }
    }
    return sysconfigDto;
}

public void updateSysconfig(SysconfigDto sysconfigDto) {
    try {
        if(sysconfigDto!=null){
            //...
            //用户和IP锁定
            if(sysconfigDto.getEnableLock() != null){
                SysconfigQo sysconfigQo = new SysconfigQo();
                sysconfigQo.setNkey(SysConfigType.USER_AND_IP_LOCK);
                Sysconfig sysconfig = sysconfigDao.queryUnique(sysconfigQo);
                if(sysconfig != null) {
                    sysconfig.setStrValue(String.valueOf(sysconfigDto.getEnableLock()));
                    sysconfig.setStrUpdatetime(new Date());
                    sysconfigDao.update(sysconfig);
                }
            }
            //最大连续失败次数
            if(sysconfigDto.getMaxFailNum() != null){
                SysconfigQo sysconfigQo = new SysconfigQo();
                sysconfigQo.setNkey(SysConfigType.FAIL_TIMES);
                Sysconfig sysconfig = sysconfigDao.queryUnique(sysconfigQo);
                if(sysconfig != null) {
                    sysconfig.setStrValue(String.valueOf(sysconfigDto.getMaxFailNum()));
                    sysconfig.setStrUpdatetime(new Date());
                    sysconfigDao.update(sysconfig);
                }
            }
            //锁定时间
            if(sysconfigDto.getLockMinutes() != null){
                SysconfigQo sysconfigQo = new SysconfigQo();
                sysconfigQo.setNkey(SysConfigType.LOCK_MINUTES);
                Sysconfig sysconfig = sysconfigDao.queryUnique(sysconfigQo);
                if(sysconfig != null) {
                    sysconfig.setStrValue(String.valueOf(sysconfigDto.getLockMinutes()));
                    sysconfig.setStrUpdatetime(new Date());
                    sysconfigDao.update(sysconfig);
                }
            }
        }
    } catch (DataLoadException e) {
        throw new ExpectedException(&quot;3&quot;);
    }
}
</code></pre>

<p>SysdictionaryDaoImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/sysconfig/dao/impl/SysconfigDaoImpl.java

public void deleteByIds(Serializable[] paramArrayOfSerializable) {
    StringBuffer hql = new StringBuffer(&quot;DELETE FROM &quot;);
    hql.append(getEntityClass().getName());

    hql.append(&quot; WHERE id in (:ids)&quot;);
    Query query = createQuery(hql.toString());
    query.setParameter(&quot;ids&quot;, StringUtils.join(paramArrayOfSerializable));
    query.executeUpdate();
}
</code></pre>

<p>DecodeDeviceServiceImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/tvwall/service/impl/DecodeDeviceServiceImpl.java

public void saveMfvcDevice(Device mfvcDevice, List&lt;Device&gt; decodeDevices, List&lt;Device&gt; encodeDevices) {
    //...

    // 保存综合平台
    Device device = new Device();
    try {
        PropertyUtils.copyProperties(device, mfvcDevice);
    } catch (Exception e) {
        throw new ExpectedException(&quot;&quot;);
    }

    device.setStrPassword(SercurityUtil.encrypt(PasswordEncryptUtil.decodeBase64(device.getStrPassword())));
    Integer nrevId = (Integer)deviceDao.save(device);

    // 循环插入数据库
    for (Device decodeDevice : decodeDevices) {
        decodeDevice.setNrev(nrevId);
        decodeDevice.setStrInterAreaCode(deviceDao.getDeviceSeril(decodeDevice.getNorgId()));
        deviceDao.save(decodeDevice);
    }
    //...
}
</code></pre>

<p>UsersServiceImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/users/service/impl/UsersServiceImpl.java

private IUserIdAndSessionDao userIdAndSessionDao;
private DataManager dataManager;
private IWorkStateDao workStateDao;

public AjaxData resetPassword(List&lt;Integer&gt; ids) {
    AjaxData ajaxData = new AjaxData(false);
    usersDao.resetUsersPassword(ids, sysconfigService.getSysconfig().getPasswordDefault());

    UserIdAndSessionQo userIdAndSessionQo = new UserIdAndSessionQo();
    userIdAndSessionQo.setUserIds(ids);
    userIdAndSessionQo.setClientType(1);
    List&lt;UserIdAndSession&gt; userIdAndSessions = userIdAndSessionDao.queryList(userIdAndSessionQo);
    if(null != userIdAndSessions){
        for(int i=0; i&lt;userIdAndSessions.size(); i++){
            String sessionId = userIdAndSessions.get(i).getSessionId();
            try {
                dataManager.remove(sessionId, DATA_TYPE.SESSION);
            } catch (DataLoadException e) {
                logger.info(&quot;connect to cache error.&quot;,e);
                return ajaxData;
            }
        }
    }

    workStateDao.updateByIds(ids);

    //...
}

public AjaxData updatePassword(Integer userId, String password, String newpassword) {
    AjaxData ajaxData = new AjaxData(false);
    Users user = usersDao.get(userId);
    if (user.getStrPassword().equals(password)) {
        if (!password.equals(newpassword)) {
            // 更新密码、修改密码时间
            user.setStrPassword(newpassword);
            user.setDtUpdatePwdTime(new Date());
            usersDao.update(user);

            List&lt;Integer&gt; ids = new ArrayList&lt;Integer&gt;(1);
            ids.add(userId);
            workStateDao.updateByIds(ids);
        } else {
            ajaxData.setFailureMsg(&quot;新密码与当前密码相同&quot;);
        }
    } else {
        ajaxData.setFailureMsg(&quot;当前密码不正确&quot;);
    }
    return ajaxData;
}
</code></pre>

<p>VehicleAction</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/vehicles/action/VehicleAction.java

public String toAddVehiclePage() {
    if (vehicleInfo.getNorgId() != null) {
        vehicleInfo.setNanalogNum(4);
        vehicleInfo.setNalarmInNum(4);
        vehicleInfo.setNalarmOutNum(1);
        vehicleInfo.setNtalkNum(1);
        vehicleInfo.setNdefaultFenceId(null);
        vehicleInfo.setNdefaultLineId(null);
        vehicleInfo.setNdefaultStaffgroupId(null);
        vehicleInfo.setNvagServerId(null);
        vehicleInfo.setNstreamServerId(null);
        vehicleInfo.setNdvrServerId(null);
        vehicleInfo.setNvrmServerId(null);
        operPage = &quot;/modules/vehicles/dialogs/vehicle-win.jsp&quot;;
        return DISPATCHER;
    } else {
        msg = &quot;未获取到车队id&quot;;
        success = false;
        return AJAX;
    }
}

public String getPolygonLine(){
    if (id != null) {
        vehicleInfo = vehicleService.getVehicleInfo(Integer.valueOf(id.toString()));
        success = true;
    }
    lines = vehicleService.getLinesOrFences(Constants.PolygonType.LINE);
    fences = vehicleService.getLinesOrFences(Constants.PolygonType.FENCE);
    staffgroups = vehicleService.getStaffGroups();
    vagServers = serverService.getServerBasicInfoByType(ServerType.MT_SERVICE_VAG);
    streamServers = serverService.getServerBasicInfoByType(ServerType.MT_SERVICE_STREAM);
    dvrServers = serverService.getServerBasicInfoByType(ServerType.MT_SERVICE_DVR);
    vrmServers = serverService.getServerBasicInfoByType(ServerType.MT_SERVICE_VRM);
    ajaxData.put(&quot;vehicleInfo&quot;, vehicleInfo);
    ajaxData.put(&quot;lines&quot;, lines);
    ajaxData.put(&quot;fences&quot;, fences);
    ajaxData.put(&quot;staffgroups&quot;, staffgroups);
    ajaxData.put(&quot;vagServers&quot;, vagServers);
    ajaxData.put(&quot;streamServers&quot;, streamServers);
    ajaxData.put(&quot;dvrServers&quot;, dvrServers);
    ajaxData.put(&quot;vrmServers&quot;, vrmServers);
    return AJAX;
}

/**
 * 跳转到车辆编辑页面
 * @author jinmeiling 2015年7月19日 下午6:28:41
 * @return
 */
public String toEditVehiclePage() {
    if (id != null) {
        vehicleInfo = vehicleService.getVehicleInfo(Integer.valueOf(id.toString()));
        operPage = &quot;/modules/vehicles/dialogs/vehicle-win.jsp&quot;;
        return DISPATCHER;
    } else {
        msg = &quot;未获取到车辆id&quot;;
        success = false;
        return AJAX;
    }
}
</code></pre>

<p>VehiclechannelDaoImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/vehicles/dao/impl/VehiclechannelDaoImpl.java

public List&lt;RegionResDTO&gt; queryRegionResList(ReqServerDataQo qo) {
    //...

    if(qo.getMoudleType() != null &amp;&amp; StringUtils.isNotEmpty(qo.getServerIp())){
        sql += &quot; join servervehiclemapping sv on sv.nvehicleId = v.id &quot;
                + &quot; join server vag on ( vag.id = sv.nserverId and vag.ntype = :serverType ) &quot;
                + &quot; join pcserverip ip on ( ip.npcserverId = vag.npcId and ip.ntype = &quot;+NetType.NET_IN +&quot; and ip.strIp = :ip ) &quot;
                + &quot; where vc.nstate= &quot;+Constants.ENABLED+&quot; &quot;;
        if(qo.getSubType()!=null){
            sql +=&quot; and vc.ntype = :ntype&quot;;
        }
        return this.createSQLQuery(sql).setParameter(&quot;ntype&quot;, qo.getSubType()).setParameter(&quot;serverType&quot;, qo.getMoudleType()).setParameter(&quot;ip&quot;, qo.getServerIp()).setResultTransformer(Transformers.aliasToBean(RegionResDTO.class)).list();
    }else if(qo.getMoudleType() == ServerType.MT_SERVICE_EVENT){
        sql +=&quot; where 1=1 &quot;;
        if(StringUtils.isNotEmpty(qo.getDataIndex())){
            sql += &quot; and vc.strInterAreaCode = :strInterAreaCode&quot;;
        }
        return this.createSQLQuery(sql).setParameter(&quot;strInterAreaCode&quot;, qo.getDataIndex()).setResultTransformer(Transformers.aliasToBean(RegionResDTO.class)).list();
    }

    sql +=&quot; where 1=1 &quot;;
    if(qo.getDataId()!=null){
        sql += &quot; and vc.id = :vcid&quot;;
        return this.createSQLQuery(sql).setParameter(&quot;vcid&quot;, qo.getDataId()).setResultTransformer(Transformers.aliasToBean(RegionResDTO.class)).list();
    }
    if(qo.getRelativeDevId()!=null){
        sql += &quot; and vc.nvehicleId = :vcnvehicleId&quot;;
        return this.createSQLQuery(sql).setParameter(&quot;vcnvehicleId&quot;, qo.getRelativeDevId()).setResultTransformer(Transformers.aliasToBean(RegionResDTO.class)).list();
    }

    //...
}
</code></pre>

<p>IDeviceService</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/vehicles/service/IDeviceService.java

/**
 * 修改密码
 * @author wangxinglei 2017年2月23日 下午2:55:09
 * @param strPassword
 * @param strNewPassword
 * @param id
 * @param passwordLevel 密码安全等级
 */
public void updateDevicePwd(String strPassword, String strNewPassword, Integer id, Integer passwordLevel);
</code></pre>

<p>DeviceServiceImpl</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/java/com/hikvision/finance/cvtms/modules/vehicles/service/impl/DeviceServiceImpl.java

@Override
public void updateDevicePwd(String strPassword, String strNewPassword,Integer id, Integer passwordLevel) {
    Device device = deviceDao.get(id);

    // 1、验证密码
    strPassword = SercurityUtil.encrypt(PasswordEncryptUtil.decodeBase64(strPassword));
    if (!strPassword.equals(device.getStrPassword())) {
        throw new ExpectedException(&quot;&quot;, &quot;原始密码输入有误&quot;);
    }
    // 2、修改密码
    strNewPassword = SercurityUtil.encrypt(PasswordEncryptUtil.decodeBase64(strNewPassword));
    device.setStrPassword(strNewPassword);
    device.setPasswordLevel(passwordLevel);
    deviceDao.update(device);

    OperationLogUtils.setContent(GlobalMessageUtil.getMessage(&quot;log.mfvcDevice.changePwd&quot;, new String[]{device.getStrName()}));
}

@Override
public void updateDevicePwdReset(String strPassword, String strNewPassword, Integer id, Integer passwordLevel) {
    Device device = deviceDao.get(id);

    // 1、验证用户密码
    Integer userid = SessionUtil.getUserSession().getUserId();
    String passUser = usersDao.get(userid).getStrPassword();
    if (!strPassword.equals(passUser)) {
        throw new ExpectedException(&quot;&quot;, &quot;登陆密码输入有误&quot;);
    }
    // 2、修改密码
    strNewPassword = SercurityUtil.encrypt(PasswordEncryptUtil.decodeBase64(strNewPassword));
    device.setStrPassword(strNewPassword);
    device.setPasswordLevel(passwordLevel);
    deviceDao.update(device);

    OperationLogUtils.setContent(GlobalMessageUtil.getMessage(&quot;log.mfvcDevice.changePwd&quot;, new String[]{device.getStrName()}));
}   
</code></pre>

<p>web.xml</p>
<pre><code>https://192.0.0.241/APP-Financial/branches/base_develop/iVMS-8000-CVTMS/Dev_v1.0.3/web/finance-cvtms-web/src/main/webapp/WEB-INF/web.xml

 &lt;servlet&gt;
    &lt;servlet-name&gt;kaptcha&lt;/servlet-name&gt;
    &lt;servlet-class&gt;com.google.code.kaptcha.servlet.KaptchaServlet&lt;/servlet-class&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;kaptcha.image.width&lt;/param-name&gt;
        &lt;param-value&gt;200&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;kaptcha.image.height&lt;/param-name&gt;
        &lt;param-value&gt;85&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;kaptcha.border.color&lt;/param-name&gt;
        &lt;param-value&gt;white&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;kaptcha.textproducer.char.length&lt;/param-name&gt;
        &lt;param-value&gt;4&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;kaptcha.textproducer.char.string&lt;/param-name&gt;
        &lt;param-value&gt;23456789QWERTYUIPASDFGHJKZXCVBNMqwertyuipasdfghjkzxcvbnm&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;kaptcha.textproducer.font.size&lt;/param-name&gt;
        &lt;param-value&gt;60&lt;/param-value&gt;
    &lt;/init-param&gt;   
    &lt;init-param&gt;
        &lt;param-name&gt;kaptcha.textproducer.char.space&lt;/param-name&gt;
        &lt;param-value&gt;6&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;kaptcha.textproducer.font.color&lt;/param-name&gt;
        &lt;param-value&gt;black&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;kaptcha.textproducer.font.names&lt;/param-name&gt;
        &lt;param-value&gt;宋体,楷体,微软雅黑&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;kaptcha.background.clear.from&lt;/param-name&gt;
        &lt;param-value&gt;white&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;kaptcha.background.clear.to&lt;/param-name&gt;
        &lt;param-value&gt;white&lt;/param-value&gt;
    &lt;/init-param&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;kaptcha&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/randomCode.jpg&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</code></pre>


</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
